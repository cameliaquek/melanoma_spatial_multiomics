---
title: "CITE-SeqPreprocessing"
output: html_document
---

```{r}
#Load library
library(Seurat)
library(dplyr)
library(ggplot2)
library(RColorBrewer)

#Load integrated object into R. This R object already integrated ADT and RNA.
all <- readRDS("Complete_integration_obj_filter1.rds")

#After loading the object, perform extra filtering to ensure that only positive markers are analysed in this script.
all_filter <- subset(all,cells =row.names(all@meta.data[!grepl("Doublet|Negative", all@meta.data$sample_ID),]))
DefaultAssay(all_filter) <- "RNA"
all_filter <- all_filter[!grepl("mm10", row.names(all_filter)),]
all_filter <- all_filter[!(grepl("RP", row.names(all_filter)) & grepl("-", row.names(all_filter))),]

#WNN method and resolution 1 is chosen 
Idents(object = all_filter) <- all_filter@meta.data$"iRNAwADTwsnn_res.1"

#Run FindAllMarkers
all.RNAmarkers <- FindAllMarkers(all_filter, min.pct = 0.15, logfc.threshold = 0.15, assay = "RNA")
all.adtmarkers <- FindAllMarkers(ptall, min.pct = 0.15, logfc.threshold = 0.15, assay = "ADT")

#Perform TPM scaling with gene length prior to SingleR
library(AnnotationHub)
hsdb = AnnotationHub()[['AH73881']]
hs.exons <- exonsBy(hsdb, by="gene")
hs.exons <- reduce(hs.exons)
hs.len <- sum(width(hs.exons))

library('biomaRt')
mart <- useDataset("hsapiens_gene_ensembl", useMart("ensembl"))
genes <- names(hs.len)
G_list <- getBM(filters= "ensembl_gene_id", attributes= c("ensembl_gene_id",
"hgnc_symbol"),values=genes,mart= mart)

uniqGList <- G_list[!duplicated(G_list$hgnc_symbol),]
keep <- row.names(all_filter@assays$RNA)[row.names(all_filter@assays$RNA) %in% uniqGList$hgnc_symbol]
rownames(uniqGList) <- uniqGList$hgnc_symbol
DefaultAssay(all_filter) <- "RNA"

#Run SingleR
library(SingleR)
library(scater)
tpmMIA <- calculateTPM(all_filter@assays$RNA[keep,], lengths=hs.len[uniqGList[keep,'ensembl_gene_id']])

iCE <-BlueprintEncodeData()#DatabaseImmuneCellExpressionData()

iRNA.pred.iref <- SingleR(test = tpmMIA, ref = iCE, assay.type.test=1, labels = iCE$label.fine,
                          clusters=all_filter@meta.data$iRNAwADTwsnn_res.1)
                          
#Prepare UMAP plot
all_filter@meta.data[,'SingleR_RNARaw_ann'] <- iRNA.pred.iref[all_filter@meta.data$iRNAwADTwsnn_res.1,'pruned.labels']
all_filter@meta.data$immune_refNA <- is.na(all_filter@meta.data$SingleR_RNARaw_ann)
all_filter2 <- subset(x = all_filter, subset = (immune_refNA == FALSE ))
#Save UMAP in PNG
png("UMAP-RNARaw.png",width=25, height=35, res=500, units = 'cm')
DimPlot(all_filter2, reduction = "iRNAwADTntwnn.umap", group.by = "SingleR_RNARaw_ann", label=T, repel=TRUE, split.by = "sample_ID", pt.size=0.8,ncol=2) + NoLegend()
dev.off()

#Save files
saveRDS(all_filter,'CITE-Seq_wnn_integrated_annotated.RDS')
write.csv(all_filter@meta.data,'MIA_annotatedMetadata.csv',)
write.csv(tpmMIA,'MIA_RNA_TPM.csv')
write.csv(all_filter@assays$ADT@counts,'MIA_ADT_SCT.csv')
write.csv(all_filter@assays$RNA@counts,'MIA_RNA_SCT.csv')
